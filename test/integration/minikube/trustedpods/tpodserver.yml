apiVersion: v1
kind: Service
metadata:
  name: tpodserver
  namespace: trustedpods
  labels:
    app: tpodserver
    coop.comrade/trusted-pods-p2p-helper: "true"
  annotations:
    coop.comrade/trusted-pods-p2p-helper: "/x/trusted-pods/provision-pod/0.0.1"

spec:
  ports:
  - port: 8080
  type: ClusterIP
  selector:
    app: tpodserver
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: trustedpods-configs
  namespace: trustedpods
data:
  config.yaml: |
    pricing:
      table:
        format: json
        # filename: pricing.json
        contents: |
          {
            "resources": [
              { "resource": "cpu", "priceForReservation": 200000000000 },
              { "resource": "memory", "priceForReservation": 500 }
            ],
            "currency": "Tokens"
          }


---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tpodserver
  namespace: trustedpods
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tpodserver
  template:
    metadata:
      labels:
        app: tpodserver
    spec:
      containers:
      - name: tpodserver
        image: host.minikube.internal:5000/comradecoop/trusted-pods/server
        command: ["tpodserver", "listen", "--address", "0.0.0.0:8080", "--config", "config.yaml", "--ipfs", "/dns4/ipfs-rpc.ipfs.svc.cluster.local/tcp/5001"]
        imagePullPolicy: Always # HACK
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: configs
          mountPath: /config.yaml
          subPath: config.yaml
          readOnly: true
      # - name: tpodmonitor
      #   image: host.minikube.internal:5000/comradecoop/trusted-pods/server
      #   command: ["tpodserver", "monitor", "--config", "config.yaml", "--rpc", "wss://rococo-contracts-rpc.polkadot.io", "-z"]
      #   imagePullPolicy: Always # HACK
      #   ports:
      #   - containerPort: 8080
      #   volumeMounts:
      #   - name: configs
      #     mountPath: /config.yaml
      #     subPath: config.yaml
      #     readOnly: true
      volumes:
      - name: configs
        configMap:
          name: trustedpods-configs
          items:
          - key: config.yaml
            path: config.yaml
      serviceAccountName: tpodserver-serviceaccount
